@using TesterBlazor.Models.InfoCredito

@inject IJSRuntime JSRuntime
@page "/InfoCredito/Personas"

<PageTitle>Manejo de personas</PageTitle>

<div class="d-flex align-items-start justify-content-between">
    <fieldset style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; border-radius: 10px; flex-grow: 1;">
        <legend>Búsqueda de persona</legend>
        <div class="d-flex align-items-center">
            <div class="form-floating flex-grow-1 me-3">
                <input type="text" class="form-control" id="floatingInput" placeholder=""
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
                <label for="floatingInput">Documento</label>
            </div>
            <button type="button" class="btn btn-lg btn-outline-success">Buscar</button>
        </div>
    </fieldset>
    <div class="card text-center ms-3" style="width: 500px;">
        <div class="card-header">
            ℹ️ Información
        </div>
        <div class="card-body">
            <h5 class="card-title">Funcionamiento</h5>
            <p class="card-text">
                En esta página se agregarán personas y buscará información particular de la misma y sus nucleos. <br />
                Para configurar nucleos nuevos, se debe de ir a la página de configuración.
            </p>
        </div>
        <div class="card-footer text-muted">
            ⚠️ Advertencia ⚠️
            <br />
            Si no se encuentra una persona, se deberá abrir un nuevo modal para agregarla.
        </div>
    </div>
</div>

<!-- Botón para abrir el modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPersonModal">
    Agregar Persona
</button>

<EditForm EditContext="EditContext" OnValidSubmit="GuardarPersona">
    <DataAnnotationsValidator />

    <!-- Modal de Agregar Persona -->
    <div class="modal fade" id="addPersonModal" tabindex="-1" aria-labelledby="addPersonModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPersonModalLabel">Agregar Persona</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Documento -->
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="personaDocumento" placeholder=""
                               @bind="NuevaPersona.NroDocumento" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
                        <label for="personaDocumento">Documento</label>
                        <ValidationMessage For="@(() => NuevaPersona.NroDocumento)" />
                    </div>

                    <!-- Nombres -->
                    <div class="row g-3 mb-3">
                        <div class="col">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="personaNombre" placeholder=""
                                       @bind="NuevaPersona.Nombre1">
                                <label for="personaNombre">Primer nombre</label>
                                <ValidationMessage For="@(() => NuevaPersona.Nombre1)" />
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="personaNombre2" placeholder=""
                                       @bind="NuevaPersona.Nombre2">
                                <label for="personaNombre2">Segundo nombre</label>
                            </div>
                        </div>
                    </div>

                    <!-- Apellidos -->
                    <div class="row g-3 mb-3">
                        <div class="col">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="personaApellido" placeholder=""
                                       @bind="NuevaPersona.Apellido1">
                                <label for="personaApellido">Primer apellido</label>
                                <ValidationMessage For="@(() => NuevaPersona.Apellido1)" />
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="personaApellido2" placeholder=""
                                       @bind="NuevaPersona.Apellido2">
                                <label for="personaApellido2">Segundo apellido</label>
                                <ValidationMessage For="@(() => NuevaPersona.Apellido2)" />
                            </div>
                        </div>
                    </div>

                    <!-- Fecha de nacimiento -->
                    <div class="form-floating mb-3 d-flex align-items-center">
                        <InputDate @bind-Value="NuevaPersona.FechaNacimiento" class="form-control" id="floatingDate" />
                        <label for="floatingDate">Fecha nacimiento</label>
                        <ValidationMessage For="@(() => NuevaPersona.FechaNacimiento)" />
                        <button type="button" class="btn btn-outline-primary ms-3" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                            Agregar Dirección
                        </button>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Agregar Dirección -->
    <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAddressModalLabel">Agregar Dirección</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" @onclick="VolverAlModalPersona"></button>
                </div>
                <div class="modal-body">
                    <!-- Dirección -->
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="direccionPais" placeholder="" @bind="NuevaPersona.Direccion.Pais">
                        <label for="direccionPais">País</label>
                        <ValidationMessage For="@(() => NuevaPersona.Direccion.Pais)" />
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="direccionCiudad" placeholder="" @bind="NuevaPersona.Direccion.Ciudad">
                        <label for="direccionCiudad">Ciudad</label>
                        <ValidationMessage For="@(() => NuevaPersona.Direccion.Ciudad)" />
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="direccionBarrio" placeholder="" @bind="NuevaPersona.Direccion.BarrioLocalidad">
                        <label for="direccionBarrio">Barrio/Localidad</label>
                        <ValidationMessage For="@(() => NuevaPersona.Direccion.BarrioLocalidad)" />
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="direccionCalle" placeholder="" @bind="NuevaPersona.Direccion.Calle">
                        <label for="direccionCalle">Calle</label>
                        <ValidationMessage For="@(() => NuevaPersona.Direccion.Calle)" />
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="direccionNumeroPuerta" placeholder="" @bind="NuevaPersona.Direccion.NumeroPuerta">
                                <label for="direccionNumeroPuerta">Número de Puerta</label>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="direccionNumeroApartamento" placeholder="" @bind="NuevaPersona.Direccion.NumeroApartamento">
                                <label for="direccionNumeroApartamento">Número de Apartamento</label>
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="direccionManzana" placeholder="" @bind="NuevaPersona.Direccion.Manzana">
                                <label for="direccionManzana">Manzana</label>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="direccionSolar" placeholder="" @bind="NuevaPersona.Direccion.Solar">
                                <label for="direccionSolar">Solar</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="direccionComentarios" placeholder="" @bind="NuevaPersona.Direccion.Comentarios"></textarea>
                        <label for="direccionComentarios">Comentarios</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" aria-label="Close">Continuar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Errores del formulario -->
    <div class="card text-center ms-3" style="width: 500px;">
        <div class="card-header">
            ⚠️ Errores del formulario ⚠️
        </div>
        <div class="card-body">
            <h5 class="card-title"></h5>
            <p class="card-text">
                <div class="validation-summary">
                    <ul>
                        <ValidationSummary />
                    </ul>
                </div>
            </p>
        </div>
        <div class="card-footer text-muted">
            De no encontrarse errores se podrá continuar
        </div>
    </div>
</EditForm>

@code {
    private EditContext EditContext { get; set; }

    protected override void OnInitialized()
    {
        EditContext = new EditContext(NuevaPersona);
    }

    private Persona NuevaPersona { get; set; } = new Persona()
    {
        Direccion = new DireccionPersona(),
        FechaNacimiento = DateTime.Today
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("initializeModals");
            await JSRuntime.InvokeVoidAsync("initializeModalEvents");
        }
    }

    private void GuardarPersona()
    {
        Console.WriteLine($"Guardando persona: {NuevaPersona.Nombre1} {NuevaPersona.Apellido1}");
        JSRuntime.InvokeVoidAsync("closeModal", "addPersonModal");
    }

    private void VolverAlModalPersona()
    {
        JSRuntime.InvokeVoidAsync("closeModal", "addAddressModal");
        JSRuntime.InvokeVoidAsync("showModal", "addPersonModal");
    }
}